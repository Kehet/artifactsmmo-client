name: Generate PHP client

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  generate_php_client:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: release-candidate

      - name: Download OpenAPI spec
        id: download
        shell: bash
        run: |
          set -euo pipefail
          
          URL="https://api.artifactsmmo.com/openapi.json"
          TMP_FILE="openapi.tmp.json"
          DEST_FILE="openapi.json"

          # Download with fail on HTTP error, follow redirects
          curl -sSfL "$URL" -o "$TMP_FILE"

          # Basic validation: must be JSON and contain .openapi and .info.version
          if ! jq -e '.openapi and .info and .info.version' "$TMP_FILE" >/dev/null; then
            echo "Downloaded file does not look like a valid OpenAPI document" >&2
            echo "continue=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Extract version for later use
          VERSION=$(jq -r '.info.version' "$TMP_FILE")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

          # Move into place
          mv "$TMP_FILE" "$DEST_FILE"

          # Detect change vs repository version
          if git ls-files --error-unmatch "$DEST_FILE" >/dev/null 2>&1; then
            if git diff --quiet -- "$DEST_FILE"; then
              echo "Spec has not changed. Skipping generation." >&2
              echo "continue=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          echo "continue=true" >> "$GITHUB_OUTPUT"

      - name: Generate code
        if: steps.download.outputs.continue == 'true'
        shell: bash
        run: |
          set -euo pipefail
          
          docker run --rm \
            -u "$(id -u):$(id -g)" \
            -v "${GITHUB_WORKSPACE}:/local" \
            openapitools/openapi-generator-cli \
            generate \
            -i /local/openapi.json \
            -g php-nextgen \
            -p composerPackageName=kehet/artifactsmmo-client,invokerPackage=\\Kehet\\ArtifactsMMO\\ \
            -o /local

      - name: Commit changes
        if: steps.download.outputs.continue == 'true'
        shell: bash
        env:
          VERSION: ${{ steps.download.outputs.version }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add . || true

          if git diff --cached --quiet; then
            echo "No changes to commit. Skipping push."
            exit 0
          fi

          git commit -m "Update client to ${VERSION}"
          git push origin HEAD:release-candidate

      - name: Open pull request to master
        if: steps.download.outputs.continue == 'true'
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.download.outputs.version }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const head = 'release-candidate';
            const base = 'master';
            const title = `Merge release-candidate into master`;
            const body = `Auto-generated PR for client update to ${process.env.VERSION}`;

            // Check if an open PR already exists from head to base
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:${head}`,
              base
            });

            if (prs.length > 0) {
              core.info('An open pull request already exists. Skipping creation.');
            } else {
              await github.rest.pulls.create({ owner, repo, head, base, title, body });
              core.info('Pull request created successfully.');
            }
